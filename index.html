<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Choosy AI</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <!-- Main structure remains the same -->
    <div class="chat-container">
        <!-- Previous HTML structure remains unchanged until the script tag -->
    </div>

    <script>
        const messagesContainer = document.getElementById('messages');
        let currentUsername = '';

        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
        }

        document.addEventListener('DOMContentLoaded', () => {
            const userName = getCookie('userName');
            if (!userName) {
                document.getElementById('setup-container').style.display = 'block';
            } else {
                currentUsername = userName;
                document.getElementById('usernameText').innerText = userName;
                alert(`Welcome back, ${userName}!`);
            }
        });

        const sendMessage = async () => {
            const messageInput = document.getElementById('message');
            const messageText = messageInput.value.trim();
            if (!messageText) return;

            // Create and display user message
            const userMessage = document.createElement('div');
            userMessage.classList.add('message', 'user');
            userMessage.innerText = messageText;
            messagesContainer.appendChild(userMessage);
            messageInput.value = '';
            messagesContainer.scrollTop = messagesContainer.scrollHeight;

            // Add loading indicator
            const loadingDiv = document.createElement('div');
            loadingDiv.classList.add('message', 'loading');
            loadingDiv.innerText = 'AI is thinking...';
            messagesContainer.appendChild(loadingDiv);

            try {
                // Send message to local server
                const response = await fetch('http://localhost:3001/process-chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: messageText,
                        userName: currentUsername || 'User'
                    })
                });

                // Remove loading indicator
                messagesContainer.removeChild(loadingDiv);

                if (!response.ok) {
                    throw new Error('Failed to get response from server');
                }

                const data = await response.json();

                if (data.error) {
                    throw new Error(data.error);
                }

                // Create and display bot message
                const botMessage = document.createElement('div');
                botMessage.classList.add('message', 'bot');
                botMessage.innerText = data.reply;

                // Make message copyable
                botMessage.onclick = () => {
                    navigator.clipboard.writeText(botMessage.innerText);
                    const copySuccessMessage = document.createElement('div');
                    copySuccessMessage.innerText = 'Copied!';
                    copySuccessMessage.classList.add('copy-success');
                    botMessage.appendChild(copySuccessMessage);
                    setTimeout(() => {
                        botMessage.removeChild(copySuccessMessage);
                    }, 1500);
                };

                messagesContainer.appendChild(botMessage);

            } catch (error) {
                // Remove loading indicator if it exists
                if (loadingDiv.parentNode) {
                    messagesContainer.removeChild(loadingDiv);
                }

                // Display error message
                const errorMessage = document.createElement('div');
                errorMessage.classList.add('message', 'error');
                errorMessage.innerText = `Error: ${error.message}`;
                messagesContainer.appendChild(errorMessage);
                console.error('Error:', error);
            }

            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        };

        // Event listeners
        document.getElementById('send-btn').addEventListener('click', sendMessage);
        document.getElementById('message').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') sendMessage();
        });

        document.getElementById('submit-btn').addEventListener('click', function() {
            const username = document.getElementById('username').value;
            if (username) {
                currentUsername = username;
                document.cookie = `userName=${username}; path=/; max-age=${60 * 60 * 24 * 365}`;
                document.getElementById('setup-container').style.display = 'none';
                document.getElementById('usernameText').innerText = username;
                document.getElementById('usernameDisplay').style.display = 'block';
                alert(`Welcome, ${username}!`);
            } else {
                alert('Please enter your name');
            }
        });

        document.getElementById('profile-icon').addEventListener('click', () => {
            const usernameDisplay = document.getElementById('usernameDisplay');
            usernameDisplay.style.display = 'block';
        });
    </script>
</body>
</html>
